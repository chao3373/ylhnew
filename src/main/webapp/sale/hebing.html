<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>订单合并</title>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">
        var url;

        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        function searchSale() {
            var clientId;
            var clerkId;
            if (isNaN($("#s_client").combobox("getValue"))) {
                clientId = "";
            } else {
                clientId = $("#s_client").combobox("getValue");
            }

            if (isNaN($("#s_clerk").combobox("getValue"))) {
                clerkId = "";
            } else {
                clerkId = $("#s_clerk").combobox("getValue");
            }
            $("#dg").datagrid({
                url: '/admin/saleList/list',
                queryParams: {
                    saleNumber: $("#s_saleNumber").val(),
                    clientId: clientId,
                    clerkId: clerkId,
                    bSaleDate: $("#s_bSaleDate").datebox("getValue"),
                    eSaleDate: $("#s_eSaleDate").datebox("getValue")
                }
            });
        }

        function formatSupplier(val, row) {
            return val.name;
        }

        //格式化日期
        Date.prototype.format = function (formatStr) {
            var str = formatStr;
            var Week = ['日', '一', '二', '三', '四', '五', '六'];
            str = str.replace(/yyyy|YYYY/, this.getFullYear());
            str = str.replace(/MM/,
                (this.getMonth() + 1) > 9 ? (this.getMonth() + 1).toString()
                    : '0' + (this.getMonth() + 1));
            str = str.replace(/dd|DD/, this.getDate() > 9 ? this.getDate()
                .toString() : '0' + this.getDate());
            return str;
        }

        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }

        //字符串转日期
        function strToDate(val) {
            var dateType = "";
            var date = new Date(val).getTime();
            return date;
        }

        function strDate(val) {
            var dateType = "";
            var date = new Date(val).format("yyyy-MM-dd");
            return date;
        }


        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        $(document)
            .ready(
                function () {

                    $("#dg").datagrid(
                        {
                            onDblClickRow: function (index, row) {
                                $("#dialog").dialog("open").dialog(
                                    "setTitle", "修改信息");
                                $("#saleNumber").val(row.saleNumber);
                                $("#saleDate").datebox("setValue", strDate(row.saleDate));
                                if (row.client) {
                                    $.ajax({
                                        type: "POST",
                                        url: "/admin/client/findByName?name=" + row.client.name,
                                        success: function (result) {
                                            $("#client").combobox("setValue", result.id);
                                        }
                                    });
                                }
                                if (row.clerk) {
                                    $.ajax({
                                        type: "POST",
                                        url: "/admin/clerk/findByName?clerk=" + row.clerk.name,
                                        success: function (result) {
                                            $("#clerk").combobox("setValue", result.id);
                                        }
                                    });
                                }
                                ;
                                $("#lankman").val(row.lankman);
                                $("#address").val(row.address);
                                $("#tel").val(row.tel);
                                $("#deliveryDate").datebox("setValue", strDate(row.deliveryDate));//发货时间
                                $("remark").val(row.remark);
                                url = "/admin/saleList/saveTwo?id="
                                    + row.id;
                            }
                        });

                    $("#dlg").dialog("close");
                    $("#s_bSaleDate").datebox("setValue",
                        genLastMonthDayStr()); // 设置上个月日期
                    $("#s_eSaleDate").datebox("setValue", genTodayStr()); // 设置当前日期

                    $("#dg")
                        .datagrid(
                            {
                                url: "/admin/saleList/list",
                                columns: [[
                                    {
                                        field: "id",
                                        width: "20",
                                        align: "center",
                                        title: "销售单ID",
                                        formatter: function (
                                            val, row) {
                                            saleListId = val;
                                            return val;
                                        },
                                    },
                                    {
                                        field: "saleNumber",
                                        width: "150",
                                        align: "center",
                                        title: "销售单号"
                                    },
                                    {
                                        field: "saleDate",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            var dateType = "";
                                            var date = new Date();
                                            date.setTime(val);
                                            dateType = date
                                                .format("yyyy-MM-dd")
                                            return dateType;
                                        },
                                        title: "销售日期"
                                    },
                                    {
                                        field: "client",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            if (row.client) {
                                                return val.name;
                                            }
                                            return "";
                                        },
                                        title: "客户"
                                    },
                                    {
                                        field: "clerk",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            if (row.clerk) {
                                                return val.name;
                                            }
                                            return "";
                                        },
                                        title: "业务员"
                                    },
                                    {
                                        field: "lankman",
                                        width: "100",
                                        align: "center",
                                        title: "联系人"
                                    },
                                    {
                                        field: "tel",
                                        width: "100",
                                        align: "center",
                                        title: "客户电话"
                                    },
                                    {
                                        field: "address",
                                        width: "200",
                                        align: "center",
                                        title: "客户地址"
                                    },
                                    {
                                        field: "deliveryDate",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            if (val) {
                                                var dateType = "";
                                                var date = new Date();
                                                date
                                                    .setTime(val);
                                                dateType = date
                                                    .format("yyyy-MM-dd")
                                                return dateType;
                                            }
                                            return;
                                        },
                                        title: "发货时间"
                                    }, {
                                        field: "remark",
                                        width: "100",
                                        align: "center",
                                        title: "备注"
                                    }

                                ]],
                                onSelect: function (index, row) {
                                    $("#cc1").combobox("reset");
                                    $("#dg2")
                                        .datagrid(
                                            {
                                                url: '/admin/saleList/listProduct',
                                                queryParams: {
                                                    saleListId: row.id
                                                },
                                                columns: [[
                                                    {
                                                        field: 'cb',
                                                        checkbox: "true",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: 'name',
                                                        title: "产品名称",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: 'peasant',
                                                        title: "农户",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "model",
                                                        title: "幅宽（m）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "price",
                                                        title: "厚度（mm）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "length",
                                                        title: "长度（m）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "hebingLength",
                                                        title: "合并长度（m）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "meter",
                                                        title: "实际厚度",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "color",
                                                        title: "颜色",
                                                        width: "50",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "oneweight",
                                                        title: "单件重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "num",
                                                        title: "订货数量",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "sumwight",
                                                        title: "总重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "realitymodel",
                                                        title: "实际幅宽（m）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "demand",
                                                        title: "要求",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "wightset",
                                                        title: "重量设置",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "dao",
                                                        title: "剖刀",
                                                        width: "150",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "brand",
                                                        title: "商标",
                                                        width: "150",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "pack",
                                                        title: "包装",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "letter",
                                                        title: "印字",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "peasant",
                                                        title: "农户名称",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "clientname",
                                                        title: "客户名称",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "realityweight",
                                                        title: "实际重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "realityprice",
                                                        title: "实际厚度（mm）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "theoryweight",
                                                        title: "理论重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "square",
                                                        title: "单件平米",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "numsquare",
                                                        title: "总平米",
                                                        width: "50",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "weightway",
                                                        title: "称重方式",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "label",
                                                        title: "标签名称",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "weight",
                                                        title: "重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "patu",
                                                        title: "纸管",
                                                        width: "50",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "remark",
                                                        title: "备注",
                                                        width: "100",
                                                        align: "center"
                                                    }, {
                                                        field: "saleList",
                                                        title: "ID",
                                                        width: "100",
                                                        align: "center",
                                                        formatter: function (val, row) {
                                                            return val.id;
                                                        }
                                                    }, {
                                                        field: "jiTai",
                                                        title: "机台",
                                                        width: "100",
                                                        align: "center",
                                                        formatter: function (val, row) {
                                                            if (val) {
                                                                return val.name;
                                                            }
                                                        }
                                                    }]]
                                            });
                                }
                            });

                });

        function formatPrice(val, row) {
            return "¥" + val;
        }

        function formatTotal(val, row) {
            return "¥" + val;
        }

        var ids;

        //审核
        function auditResult(value) {
            var selectedRows = $("#dg2").datagrid("getSelections");
            if (selectedRows.length == 0) {
                $.messager.alert("系统提示", "请选择要审核的信息！");
                return;
            }
            var strIds = [];
            for (var i = 0; i < selectedRows.length; i++) {
                strIds.push(selectedRows[i].id);
            }
            ids = strIds.join(",");
            //审核成功
            if (value == 1) {
                $.messager
                    .confirm(
                        "系统提示",
                        "您确定审核这些数据吗？",
                        function (r) {
                            if (r) {
                                $
                                    .post(
                                        "/admin/saleListProduct/passTheAudit",
                                        {
                                            ids: ids
                                        },
                                        function (result) {
                                            if (result.success) {
                                                $.messager.alert(
                                                    "系统提示",
                                                    "审核已通过!");
                                                $
                                                    .post(
                                                        "/admin/saleListProduct/listAllBySaleList",
                                                        {
                                                            id: $(
                                                                "#dg")
                                                                .datagrid(
                                                                    "getSelections")[0].id
                                                        },
                                                        function (
                                                            data) {
                                                            if (data.success) {

                                                            }
                                                        });
                                                $("#dg")
                                                    .datagrid(
                                                        "selectRecord",
                                                        $(
                                                            "#dg")
                                                            .datagrid(
                                                                "getSelections")[0].id);
                                                console
                                                    .log($(
                                                        "#dg")
                                                        .datagrid(
                                                            "getSelections")[0].id);
                                                $("#dg2").datagrid(
                                                    "reload");
                                            } else {
                                                $.messager
                                                    .alert(
                                                        "系统提示",
                                                        result.errorInfo);
                                            }
                                        });

                            }
                        });
            } else if (value == 0) {//审核失败
                $("#dlg").dialog("open");
            }
        }

        //提交审核未通过原因
        function saveCause() {
            var cause = "审核失败：" + $("#cause").val();
            alert(cause);
            alert("saveCause" + ids);
            $.post("/admin/saleListProduct/auditFailure", {
                ids: ids,
                cause: cause
            }, function (result) {
                if (result.success) {
                    $.messager.alert("系统提示", "审核结果已提交");
                    $("#dg2").datagrid("reload");
                } else {
                    $.messager.alert("系统提示", result.errorInfo);
                }
            });
            closeCause();
        }

        //关闭审核未通过原因面板
        function closeCause() {
            $("#dlg").dialog("close");
            $("#dialog").dialog("close");
        }

        //根据审核条件进行订单商品信息的查询
        function auditQuery(value) {
            var selectenRows = $("#dg").datagrid("getSelections");
            if (selectenRows.length != 1) {
                $.messager
                    .confirm(
                        "系统提示",
                        "<span style='color: red;'>请选择一条销售信息</span>");
                return;
            } else {
                if (value == "未审核") {
                    value = "下单";
                }
                $("#dg2")
                    .datagrid(
                        {
                            url: '/admin/saleList/listProductByState',
                            queryParams: {
                                id: selectenRows[0].id,
                                state: value
                            },
                            columns: [[
                                {
                                    field: 'cb',
                                    checkbox: "true",
                                    align: "center"
                                },
                                {
                                    field: 'state',
                                    title: "订单状态",
                                    width: "150",
                                    align: "center",
                                    formatter: function (value, row,
                                                         index) {
                                        if (row.state == "下单") {
                                            $("#state").css("color",
                                                "#FF0000");
                                            return '<span style="color:#0000FF">'
                                                + '未审核' + '</span>';
                                        } else if (row.state
                                            .indexOf("审核失败") == 0) {
                                            return '<span style="color:#FF0000">'
                                                + row.state
                                                + '</span>';
                                        } else if (row.state == "审核通过") {
                                            return '<span style="color:#0B610B">'
                                                + row.state
                                                + '</span>';
                                        } else {
                                            return '<span style="color:#8A0829">'
                                                + row.state
                                                + '</span>';
                                        }
                                    }
                                }, {
                                    field: 'name',
                                    title: "产品名称",
                                    width: "200",
                                    align: "center"
                                },{
                                    field: 'peasant',
                                    title: "农户",
                                    width: "200",
                                    align: "center"
                                }, {
                                    field: "model",
                                    title: "幅宽（m）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "price",
                                    title: "厚度（mm）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "length",
                                    title: "长度（m）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "meter",
                                    title: "实际厚度",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "color",
                                    title: "颜色",
                                    width: "50",
                                    align: "center"
                                }, {
                                    field: "oneweight",
                                    title: "单件重量（kg）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "num",
                                    title: "订货数量",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "sumwight",
                                    title: "总重量（kg）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "realitymodel",
                                    title: "实际幅宽（m）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "demand",
                                    title: "要求",
                                    width: "200",
                                    align: "center"
                                }, {
                                    field: "wightset",
                                    title: "重量设置",
                                    width: "200",
                                    align: "center"
                                }, {
                                    field: "dao",
                                    title: "剖刀",
                                    width: "150",
                                    align: "center"
                                }, {
                                    field: "brand",
                                    title: "商标",
                                    width: "150",
                                    align: "center"
                                }, {
                                    field: "pack",
                                    title: "包装",
                                    width: "200",
                                    align: "center"
                                }, {
                                    field: "letter",
                                    title: "印字",
                                    width: "200",
                                    align: "center"
                                }, {
                                    field: "peasant",
                                    title: "农户名称",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "clientname",
                                    title: "客户名称",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "realityweight",
                                    title: "实际重量（kg）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "realityprice",
                                    title: "实际厚度（mm）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "theoryweight",
                                    title: "理论重量（kg）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "square",
                                    title: "单件平米",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "numsquare",
                                    title: "总平米",
                                    width: "50",
                                    align: "center"
                                }, {
                                    field: "weightway",
                                    title: "称重方式",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "label",
                                    title: "标签名称",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "weight",
                                    title: "重量（kg）",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "patu",
                                    title: "纸管",
                                    width: "50",
                                    align: "center"
                                }, {
                                    field: "remark",
                                    title: "备注",
                                    width: "100",
                                    align: "center"
                                }, {
                                    field: "saleListId",
                                    title: "ID",
                                    width: "100",
                                    align: "center",
                                    formatter: function (val, row) {
                                        return "";
                                    }
                                }]]
                        });
            }
        }

        //合并订单
        function hebing() {

        }

        function baocun() {
            $.post(url, {
                saleNumber: $("#saleNumber").val(),
                saleDateq: $("#saleDate").datebox("getValue"),
                client: $("#client").combobox("getValue"),
                clerk: $("#clerk").combobox("getValue"),
                lankman: $("#lankman").val(),
                tel: $("#tel").val(),
                address: $("#address").val(),
                deliveryDateq: $("#deliveryDate").datebox("getValue"),
                remark: $("#remark").val()
            }, function (result) {
                if (result.success) {
                    $.messager.alert("系统提示", "保存成功！");
                    resetValue();
                    $("#dialog").dialog("close");
                    $("#dg").datagrid("reload");
                } else {
                    $.messager.alert("系统提示", result.errorInfo);
                }
            });
        }

        function openRoleModifyDialog() {
            var selectedRows = $("#dg").datagrid("getSelections");
            if (selectedRows.length != 1) {
                $.messager.alert("系统提示", "请选择一条要修改的数据！");
                return;
            }
            var row = selectedRows[0];
            $("#dialog").dialog("open").dialog("setTitle", "修改信息");
            $("#saleNumber").val(row.saleNumber);
            $("#saleDate").datebox("setValue", strDate(row.saleDate));
            $("#client").combobox("setValue", row.client.name);
            $("#clerk").combobox("setValue", row.clerk.name);
            $("#lankman").val(row.lankman);
            $("#address").val(row.address);
            $("#tel").val(row.tel);
            $("#deliveryDate").datebox("setValue", strDate(row.deliveryDate));//发货时间
            $("remark").val(row.remark);
            url = "/admin/saleList/saveTwo?id="
                + row.id;
        }

        function resetValue() {
            $("#client").combobox('reset');
            $("#clerk").combobox('reset');
            $("#saleDate").datebox('reset');
            $("#deliveryDate").datebox('reset');
            $("#saleNumber").val("");
            $("#lankman").val("");
            $("#tel").val("");
            $("#address").val("");
            $("#remark").val("");

        }

        var a;

        //修改saleListProduct
        function editSaleListProduct() {
            var row = $("#dg2").datagrid("getSelections");
            if (row.length != 1) {
                $.messager.alert("系统提示", "<span style='color: red;'>请选择一行要修改的数据！！</span>");
                return;
            }
            var rows = row[0];
            // console.log(rows);
            a = rows.accomplishNumber == null ? 0 : rows.accomplishNumber;
            if (rows.state == "提货" || rows.state == "装车") {
                $.messager.alert("系统提示", "<span style='color: red;'>产品已生产完成！不可修改！！</span>");
            } else {
                if (rows.state == "审核通过" || rows.state == "下单") {
                    rows.jiTai = null;
                    rows.informNumber = null;
                } else if (rows.state.startsWith("生产完成")) {
                    rows.state = "下发机台：" + row[0].jiTai.name;
                    rows.jiTai = row[0].jiTai.id;
                }
                $("#dlg2").dialog("open").dialog("setTitle", "修改商标信息");
                $("#saleList").val(rows.saleList);
                rows.saleList = row[0].saleList.id;

                $("#fm2").form("load", rows);
            }
        }

        function change() {
            $.post("/admin//", {
                id: row[0].id,
                state: "下发机台：",
            }, function (result) {
                if (result.success) {
                    $("#dg").datagrid("reload");
                }
            });
        }

        //关闭dig2
        function closeGoodsDialog() {
            $("#dlg2").dialog("close");
        }

        //保存修改
        //封装订单信息传递后台
        function saveGoods() {
            $("#fm2").form("submit", {
                url: "/admin/saleListProduct/saveInfo",
                onSubmit: function () {
                    if (!$(this).form("validate")) {
                        return false;
                    }
                    if (a >= $("#num").val()) {
                        $.messager.alert("系统提示", "生产已完成，数量无法减少！");
                        return false;
                    }
                    return true;
                },
                success: function (result) {
                    // console.log(result);
                    // console.log(typeof(result));
                    // var results = eval('(' + result + ')');
                    if (result.success) {
                        alert("保存成功！");
                        window.location.reload();
                    } else {
                        $.messager.alert("系统提示", "保存失败！");
                    }
                }
            });
        }

        //指定件数合并
        function hebingJian() {
            console.log($("#dg2").datagrid('getSelections')[0]);
            if ($("#dg2").datagrid('getSelections').length != 1) {
                $.messager.alert("系统提示", "<span style='color: red'>只能选择一行要合并的订单信息</span>");
                return;
            }
            $.messager.prompt("确定合并件数", "几件合成为一件：", function (r) {
                if (r) {
                    var num = $("#dg2").datagrid('getSelections')[0].num;
                    var id = $("#dg2").datagrid('getSelections')[0].id;
                    if (isNaN(r) || Number(r) > num) {
                        alert("参数有误");
                        return;
                    }
                    $.ajax({
                        url: "/admin/saleListProduct/hebingJian?count=" + Number(r) + "&id=" + id,
                        async: false,
                        success: function (result) {
                            if (result.success) {
                                alert("合并成功！");
                                var index = $("#dg").datagrid("getRowIndex",$("#dg").datagrid("getSelected"));
                                // $("#dg2").datagrid('loadData',[]);
                                // $("#dg").datagrid('reload');
                                $("#dg").datagrid("selectRow", index);
                            }
                        }
                    });
                }
            })
        }

        //合并成一件
        function hebingOne() {
            var rows = $("#dg2").datagrid('getSelections')
            var name = rows[0].peasant;
            var model = rows[0].model;
            var price = rows[0].price;
            var meter = rows[0].meter;
            var ids = [];
            for (var i = 0; i < rows.length; i++) {
                var id = rows[i].id;
                ids.push(id);
                if (rows[i].peasant != name) {
                    alert("选择的客户不一致！");
                    return;
                }
                if (rows[i].model != model) {
                    alert("选择的宽度不一致！");
                    return;
                }
                if (rows[i].price != price) {
                    alert("选择的厚度不一致！");
                    return;
                }
                if (rows[i].meter != meter) {
                    alert("选择的实际厚度不一致！");
                    return;
                }
            }

            ids.join(",");

            $.ajax({
                url: "/admin/saleListProduct/hebingOne?ids=" + ids,
                success: function (result) {
                    if (result.success) {
                        alert("合并成功");
                        var index = $("#dg").datagrid("getRowIndex",$("#dg").datagrid("getSelected"));
                        // $("#dg2").datagrid('loadData',[]);
                        // $("#dg").datagrid('reload');
                        $("#dg").datagrid("selectRow", index);
                    }
                }
            });

        }

    </script>
</head>
<body class="easyui-layout" style="margin: 1px">
<div region="north" style="height: 300px">
    <table id="dg" title="销售单据查询" class="easyui-datagrid"
           fitColumns="false" rownumbers="true" singleSelect="true" fit="true"
           toolbar="#tb" split="true">
        <thead>
        <th field="id" width="20" align="center">销售单号</th>
        <th field="saleNumber" width="150" align="center">销售单号</th>
        <th field="saleDate" width="100" align="center"
            formatter="formatDate">销售日期
        </th>
        <th field="client" width="100" align="center"
            formatter="formatSupplier">客户
        </th>
        <th field="clerk" width="100" align="center"
            formatter="formatSupplier">业务员
        </th>
        <th field="user" width="150" align="center" formatter="formatUser">操作员</th>
        <th field="lankman" width="100" align="center">联系人</th>
        <th field="tel" width="100" align="center">客户电话</th>
        <th field="address" width="200" align="center">客户地址</th>
        <th field="deliveryDate" width="100" align="center"
            formatter="formatDate">发货时间
        </th>
        <th field="remark" width="100" align="center">备注</th>
        </thead>
    </table>

    <!-- dg顶部工具栏 -->
    <div id="tb">
        <fieldset style="border-color: #E7F0FF">
            <legend>查询设置</legend>
            &nbsp;单据号&nbsp; <input type="text" id="s_saleNumber" size="15"
                                   onkeydown="if(event.keyCode==13) searchSale()"/>
            &nbsp;&nbsp;&nbsp;客户：&nbsp;<input class="easyui-combobox"
                                              id="s_client" name="client.id" style="width: 200px"
                                              data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/client/clientList'"/>
            &nbsp;&nbsp;&nbsp;业务员：&nbsp;<input class="easyui-combobox"
                                               id="s_clerk" name="clerk.id" style="width: 100px"
                                               data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/clerk/clerkList'"/>
            &nbsp;&nbsp;&nbsp;日期：&nbsp; <input id="s_bSaleDate"
                                               class="easyui-datebox" editable=false style="width: 100px"/>
            &nbsp;&nbsp;&nbsp;&nbsp; <input id="s_eSaleDate"
                                            class="easyui-datebox" editable=false style="width: 100px"/>
            &nbsp;&nbsp;<a href="javascript:searchSale()"
                           class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>
        </fieldset>
    </div>
</div>

<div region="center" style="margin-top: 5px">
    <table id="dg2" class="easyui-datagrid" fitColumns="false"
           rownumbers="true" fit="true" split="true" toolbar="#tb2">
    </table>
</div>

<div id="tb2">
    <div>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:hebingJian()"
                                         class="easyui-linkbutton" iconCls="icon-ok" plain="true">指定件数合并</a>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript:hebingOne()"
                                         class="easyui-linkbutton" iconCls="icon-ok" plain="true">合并为一件</a>
    </div>
</div>

<!-- 审核时的确定关闭按钮 -->
<div id="dlg-buttons">
    <a href="javascript:saveCause()" class="easyui-linkbutton"
       iconCls="icon-ok">确定</a> <a href="javascript:closeCause()"
                                   class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>

<div id="dlg2" class="easyui-dialog"
     style="width: 600px; height: 450px; padding: 10px 20px" closed="true"
     buttons="#dlg-buttons2" title="修改订单商品信息" data-options="onClose:function(){resetValue()}">
    <form id="fm2" method="post">
        <table>
            <tr>
                <td>产&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;品&nbsp;&nbsp;&nbsp;&nbsp;名&nbsp;&nbsp;&nbsp;&nbsp;称
                    ：
                </td>
                <td><input type="hidden" id="action"/> <input type="hidden"
                                                              id="rowIndex"/> <input type="text" id="name" name="name"
                                                                                     class="easyui-combobox"
                                                                                     style="width: 119px"
                                                                                     data-options="demandd:true,panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/product/productList'"/>
                </td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>幅&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;宽（m）&nbsp;：</td>
                <td><input type="text" id="model" name="model"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>厚&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;度（mm）：</td>
                <td><input type="text" id="price" name="price"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>长&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;度（m） ：</td>
                <td><input type="text" id="length" name="length"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>颜&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;色
                    ：
                </td>
                <td><input type="text" id="color" name="color"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>实际幅宽（m） ：</td>
                <td><input type="text" id="realitymodel" name="realitymodel"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>实际厚度（mm） ：</td>
                <td><input type="text" id="realityprice" name="realityprice"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>订&nbsp;&nbsp;&nbsp;货&nbsp;&nbsp;&nbsp;数&nbsp;&nbsp;&nbsp;量&nbsp;&nbsp;：</td>
                <td><input type="text" id="num" name="num"
                           class="easyui-numberbox" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>理论重量（k&nbsp;&nbsp;&nbsp;g）：</td>
                <td><input type="text" id="theoryweight" name="theoryweight"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>单件重量（kg）：</td>
                <td><input type="text" id="oneweight" name="oneweight"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>单&nbsp;&nbsp;&nbsp;
                    件&nbsp;&nbsp;&nbsp;&nbsp;平&nbsp;&nbsp;&nbsp;&nbsp;米&nbsp;&nbsp;：
                </td>
                <td><input type="text" id="square" name="square"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>总&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;平&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;米：</td>
                <td><input type="text" id="numsquare" name="numsquare"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>要&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;求
                    ：
                </td>
                <td><input type="text" id="demand" name="demand"
                           class="easyui-combobox" style="width: 120px" id="demandId"
                           name="demand.id" style="width: 100px"
                           data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/require/requireList'"/>
                </td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>称&nbsp;&nbsp;&nbsp;重&nbsp;&nbsp;&nbsp;方&nbsp;&nbsp;&nbsp;式
                    &nbsp;：
                </td>
                <td><input type="text" id="weightway" name="weightway"
                           class="easyui-validatebox" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>标&nbsp;&nbsp;&nbsp;&nbsp;签&nbsp;&nbsp;&nbsp;&nbsp;名&nbsp;&nbsp;&nbsp;&nbsp;称&nbsp;&nbsp;：</td>
                <td><input type="text" id="label" name="label"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>农&nbsp;&nbsp;&nbsp;户&nbsp;&nbsp;&nbsp;名&nbsp;&nbsp;&nbsp;称&nbsp;&nbsp;：</td>
                <td><input type="text" id="peasant" name="peasant"
                           class="easyui-validatebox" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>重&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;量（kg）&nbsp;：</td>
                <td><input type="text" id="weight" name="weight"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>剖&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;刀&nbsp;：</td>
                <td><input type="text" id="dao" name="dao"
                           class="easyui-combobox" style="width: 120px" id="daoId"
                           name="dao.id" style="width: 100px"
                           data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/dao/daoList'"/>
                </td>
            </tr>
            <tr>
                <td>商&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;标&nbsp;：</td>
                <td><input type="text" id="brand" name="brand"
                           class="easyui-combobox" style="width: 120px" id="brandId"
                           name="brand.id" style="width: 100px"
                           data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/brand/brandList'"/>
                </td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>包&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;装&nbsp;：</td>
                <td><input type="text" id="pack" name="pack"
                           class="easyui-combobox" style="width: 120px" id="packId"
                           name="pack.id" style="width: 100px"
                           data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/pack/packList'"/>
                </td>
            </tr>
            <tr>
                <td>印&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;字&nbsp;：</td>
                <td><input type="text" id="letter" name="letter"
                           class="easyui-combobox" style="width: 120px" id="letterId"
                           name="letter.id" style="width: 100px"
                           data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/letter/letterList'"/>
                </td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>纸&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;管&nbsp;：</td>
                <td><input type="text" id="patu" name="patu"
                           class="easyui-combobox" style="width: 120px" id="patuId"
                           name="patu.id" style="width: 100px"
                           data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/patu/patuList'"/>
                </td>
            </tr>
            <tr>
                <td>重&nbsp;&nbsp;&nbsp;&nbsp;量&nbsp;&nbsp;&nbsp;&nbsp;设&nbsp;&nbsp;&nbsp;&nbsp;置&nbsp;&nbsp;：</td>
                <td><input type="text" id="wightset" name="wightset"
                           class="easyui-combobox" style="width: 120px" id="wightId"
                           name="wight.id" style="width: 100px"
                           data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/wight/wightList'"/>
                </td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>总&nbsp;&nbsp;重&nbsp;&nbsp;量（kg）：</td>
                <td><input type="text" id="sumwight" name="sumwight"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>生&nbsp;&nbsp;&nbsp;
                    产&nbsp;&nbsp;&nbsp;&nbsp;米&nbsp;&nbsp;&nbsp;&nbsp;数&nbsp;&nbsp;：
                </td>
                <td><input type="text" id="meter" name="meter"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>客&nbsp;&nbsp;&nbsp;&nbsp;户&nbsp;&nbsp;&nbsp;&nbsp;名&nbsp;&nbsp;&nbsp;称：</td>
                <td><input type="text" id="clientname" name="clientname"
                           class="easyui-validatebox" style="width: 120px"/></td>
            </tr>
            <tr>
                <td>实&nbsp;&nbsp;&nbsp;际&nbsp;&nbsp;&nbsp;&nbsp;重&nbsp;&nbsp;&nbsp;&nbsp;量&nbsp;&nbsp;&nbsp;：</td>
                <td><input type="text" id="realityweight" name="realityweight"
                           class="easyui-numberbox" precision="2" style="width: 120px"/></td>
                <td>&nbsp;&nbsp;&nbsp;&nbsp;</td>
                <td>备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注&nbsp;：</td>
                <td><input type="text" id="remarks" name="remark"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td>
                    <input type="text" id="saleList" name="saleList" class="easyui-validatebox"
                           style="width: 120px"/>
                </td>
                <td><input type="text" id="jiTai" name="jiTai"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td><input type="text" id="accomplishNumber" name="accomplishNumber"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td><input type="text" id="issueState" name="issueState"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td><input type="text" id="informNumber" name="informNumber"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td><input type="text" id="state" name="state"
                           class="easyui-validatebox" style="width: 120px"/></td>
                <td>id<input type="text" id="id" name="id"
                             class="easyui-validatebox" style="width: 120px"/></td>

            </tr>
        </table>
    </form>
</div>

<div id="dlg-buttons2">
    <a href="javascript:saveGoods()" class="easyui-linkbutton" iconCls="icon-ok">保存</a> <a
        href="javascript:closeGoodsDialog()" class="easyui-linkbutton" iconCls="icon-cancel">关闭</a>
</div>
</body>
</html>
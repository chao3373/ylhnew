 <!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>订单加急</title>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">
        var url;

        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }

        function searchSale() {
            var clientId;
            var clerkId;
            if (isNaN($("#s_client").combobox("getValue"))) {
                clientId = "";
            } else {
                clientId = $("#s_client").combobox("getValue");
            }

            if (isNaN($("#s_clerk").combobox("getValue"))) {
                clerkId = "";
            } else {
                clerkId = $("#s_clerk").combobox("getValue");
            }
            $("#dg").datagrid({
                url: '/admin/saleList/list',
                queryParams: {
                    saleNumber: $("#s_saleNumber").val(),
                    clientId: clientId,
                    clerkId: clerkId,
                    bSaleDate: $("#s_bSaleDate").datebox("getValue"),
                    eSaleDate: $("#s_eSaleDate").datebox("getValue")
                }
            });
        }

        function formatSupplier(val, row) {
            return val.name;
        }

        //格式化日期
        Date.prototype.format = function (formatStr) {
            var str = formatStr;
            var Week = ['日', '一', '二', '三', '四', '五', '六'];
            str = str.replace(/yyyy|YYYY/, this.getFullYear());
            str = str.replace(/MM/,
                (this.getMonth() + 1) > 9 ? (this.getMonth() + 1).toString()
                    : '0' + (this.getMonth() + 1));
            str = str.replace(/dd|DD/, this.getDate() > 9 ? this.getDate()
                .toString() : '0' + this.getDate());
            return str;
        }

        //显示时间数据时先进行格式化
        function formatDate(val, row) {
            var dateType = "";
            var date = new Date();
            date.setTime(val);
            dateType = date.format("yyyy-MM-dd")
            return dateType;
        }

        //字符串转日期
        function strToDate(val) {
            var dateType = "";
            var date = new Date(val).getTime();
            return date;
        }

        function strDate(val) {
            var dateType = "";
            var date = new Date(val).format("yyyy-MM-dd");
            return date;
        }


        function formatUser(val, row) {
            return val.trueName + "&nbsp;(" + val.userName + ")&nbsp;";
        }
        $(document).ready(
                function () {
                    $('#dg2').datagrid({
                        rowStyler:function(index,row){
                            if (row.level || row.level != 0) {
                                return 'background-color:orange;color:blue;font-weight:bold;';
                            }
                        }
                    });


                    $("#dg").datagrid(
                        {
                            onDblClickRow: function (index, row) {
                                $("#dialog").dialog("open").dialog(
                                    "setTitle", "修改信息");
                                $("#saleNumber").val(row.saleNumber);
                                $("#saleDate").datebox("setValue", strDate(row.saleDate));
                                if (row.client) {
                                    $.ajax({
                                        type: "POST",
                                        url: "/admin/client/findByName?name=" + row.client.name,
                                        success: function (result) {
                                            $("#client").combobox("setValue", result.id);
                                        }
                                    });
                                }
                                if (row.clerk) {
                                    $.ajax({
                                        type: "POST",
                                        url: "/admin/clerk/findByName?clerk=" + row.clerk.name,
                                        success: function (result) {
                                            $("#clerk").combobox("setValue", result.id);
                                        }
                                    });
                                }
                                ;
                                $("#lankman").val(row.lankman);
                                $("#address").val(row.address);
                                $("#tel").val(row.tel);
                                $("#deliveryDate").datebox("setValue", strDate(row.deliveryDate));//发货时间
                                $("remark").val(row.remark);
                                url = "/admin/saleList/saveTwo?id="
                                    + row.id;
                            }
                        });

                    $("#dlg").dialog("close");
                    $("#s_bSaleDate").datebox("setValue",
                        genLastMonthDayStr()); // 设置上个月日期
                    $("#s_eSaleDate").datebox("setValue", genTodayStr()); // 设置当前日期

                    $("#dg")
                        .datagrid(
                            {
                                url: "/admin/saleList/list",
                                columns: [[
                                    {
                                        field: "id",
                                        width: "20",
                                        align: "center",
                                        title: "销售单ID",
                                        formatter: function (
                                            val, row) {
                                            saleListId = val;
                                            return val;
                                        },
                                    },
                                    {
                                        field: "saleNumber",
                                        width: "150",
                                        align: "center",
                                        title: "销售单号"
                                    },
                                    {
                                        field: "saleDate",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            var dateType = "";
                                            var date = new Date();
                                            date.setTime(val);
                                            dateType = date
                                                .format("yyyy-MM-dd")
                                            return dateType;
                                        },
                                        title: "销售日期"
                                    },
                                    {
                                        field: "client",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            if (row.client) {
                                                return val.name;
                                            }
                                            return "";
                                        },
                                        title: "客户"
                                    },
                                    {
                                        field: "clerk",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            if (row.clerk) {
                                                return val.name;
                                            }
                                            return "";
                                        },
                                        title: "业务员"
                                    },
                                    {
                                        field: "lankman",
                                        width: "100",
                                        align: "center",
                                        title: "联系人"
                                    },
                                    {
                                        field: "tel",
                                        width: "100",
                                        align: "center",
                                        title: "客户电话"
                                    },
                                    {
                                        field: "address",
                                        width: "200",
                                        align: "center",
                                        title: "客户地址"
                                    },
                                    {
                                        field: "deliveryDate",
                                        width: "100",
                                        align: "center",
                                        formatter: function (
                                            val, row) {
                                            if (val) {
                                                var dateType = "";
                                                var date = new Date();
                                                date
                                                    .setTime(val);
                                                dateType = date
                                                    .format("yyyy-MM-dd")
                                                return dateType;
                                            }
                                            return;
                                        },
                                        title: "发货时间"
                                    }, {
                                        field: "remark",
                                        width: "100",
                                        align: "center",
                                        title: "备注"
                                    }

                                ]],
                                onClickRow: function (index, row) {
                                    $("#cc1").combobox("reset");
                                    $("#dg2")
                                        .datagrid(
                                            {
                                                url: '/admin/saleList/listProduct',
                                                queryParams: {
                                                    saleListId: row.id
                                                },
                                                columns: [[
                                                    {
                                                        field: 'cb',
                                                        checkbox: "true",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: 'state',
                                                        title: "订单状态",
                                                        width: "150",
                                                        align: "center",
                                                        formatter: function (
                                                            value,
                                                            row,
                                                            index) {
                                                            if (row.state == "下单") {
                                                                $(
                                                                    "#state")
                                                                    .css(
                                                                        "color",
                                                                        "#FF0000");
                                                                return '<span style="color:#0000FF">'
                                                                    + '未审核'
                                                                    + '</span>';
                                                            } else if (row.state
                                                                .indexOf("审核失败") == 0) {
                                                                return '<span style="color:#FF0000">'
                                                                    + row.state
                                                                    + '</span>';
                                                            } else if (row.state == "审核通过") {
                                                                return '<span style="color:#0B610B">'
                                                                    + row.state
                                                                    + '</span>';
                                                            } else {
                                                                return '<span style="color:#8A0829">'
                                                                    + row.state
                                                                    + '</span>';
                                                            }
                                                        }
                                                    },
                                                    {
                                                        field: 'name',
                                                        title: "产品名称",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "model",
                                                        title: "幅宽（m）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "price",
                                                        title: "厚度（mm）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "length",
                                                        title: "长度（m）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "meter",
                                                        title: "实际厚度",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "color",
                                                        title: "颜色",
                                                        width: "50",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "oneweight",
                                                        title: "单件重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "num",
                                                        title: "订货数量",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "sumwight",
                                                        title: "总重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "realitymodel",
                                                        title: "实际幅宽（m）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "demand",
                                                        title: "要求",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "wightset",
                                                        title: "重量设置",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "dao",
                                                        title: "剖刀",
                                                        width: "150",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "brand",
                                                        title: "商标",
                                                        width: "150",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "pack",
                                                        title: "包装",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "letter",
                                                        title: "印字",
                                                        width: "200",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "peasant",
                                                        title: "农户名称",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "clientname",
                                                        title: "客户名称",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "realityweight",
                                                        title: "实际重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "realityprice",
                                                        title: "实际厚度（mm）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "theoryweight",
                                                        title: "理论重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "square",
                                                        title: "单件平米",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "numsquare",
                                                        title: "总平米",
                                                        width: "50",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "weightway",
                                                        title: "称重方式",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "label",
                                                        title: "标签名称",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "weight",
                                                        title: "重量（kg）",
                                                        width: "100",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "patu",
                                                        title: "纸管",
                                                        width: "50",
                                                        align: "center"
                                                    },
                                                    {
                                                        field: "remark",
                                                        title: "备注",
                                                        width: "100",
                                                        align: "center"
                                                    }, {
                                                        field: "saleList",
                                                        title: "ID",
                                                        width: "100",
                                                        align: "center",
                                                        formatter: function (val, row) {
                                                            return val.id;
                                                        }
                                                    }, {
                                                        field: "jiTai",
                                                        title: "机台",
                                                        width: "100",
                                                        align: "center",
                                                        formatter: function (val, row) {
                                                            if (val) {
                                                                return val.name;
                                                            }
                                                        }
                                                    }]]
                                            });
                                }
                            });

                });

        function formatPrice(val, row) {
            return "¥" + val;
        }

        function formatTotal(val, row) {
            return "¥" + val;
        }

        var ids;

        //审核
        function auditResult(value) {
            var selectedRows = $("#dg2").datagrid("getSelections");
            if (selectedRows.length == 0) {
                $.messager.alert("系统提示", "请选择要审核的信息！");
                return;
            }
            var strIds = [];
            for (var i = 0; i < selectedRows.length; i++) {
                strIds.push(selectedRows[i].id);
            }
            ids = strIds.join(",");
            //审核成功
            if (value == 1) {
                $.messager
                    .confirm(
                        "系统提示",
                        "您确定审核这些数据吗？",
                        function (r) {
                            if (r) {
                                $
                                    .post(
                                        "/admin/saleListProduct/passTheAudit",
                                        {
                                            ids: ids
                                        },
                                        function (result) {
                                            if (result.success) {
                                                $.messager.alert(
                                                    "系统提示",
                                                    "审核已通过!");
                                                $
                                                    .post(
                                                        "/admin/saleListProduct/listAllBySaleList",
                                                        {
                                                            id: $(
                                                                "#dg")
                                                                .datagrid(
                                                                    "getSelections")[0].id
                                                        },
                                                        function (
                                                            data) {
                                                            if (data.success) {

                                                            }
                                                        });
                                                $("#dg")
                                                    .datagrid(
                                                        "selectRecord",
                                                        $(
                                                            "#dg")
                                                            .datagrid(
                                                                "getSelections")[0].id);
                                                console
                                                    .log($(
                                                        "#dg")
                                                        .datagrid(
                                                            "getSelections")[0].id);
                                                $("#dg2").datagrid(
                                                    "reload");
                                            } else {
                                                $.messager
                                                    .alert(
                                                        "系统提示",
                                                        result.errorInfo);
                                            }
                                        });

                            }
                        });
            } else if (value == 0) {//审核失败
                $("#dlg").dialog("open");
            }
        }



        function baocun() {
            $.post(url, {
                saleNumber: $("#saleNumber").val(),
                saleDateq: $("#saleDate").datebox("getValue"),
                client: $("#client").combobox("getValue"),
                clerk: $("#clerk").combobox("getValue"),
                lankman: $("#lankman").val(),
                tel: $("#tel").val(),
                address: $("#address").val(),
                deliveryDateq: $("#deliveryDate").datebox("getValue"),
                remark: $("#remark").val()
            }, function (result) {
                if (result.success) {
                    $.messager.alert("系统提示", "保存成功！");
                    resetValue();
                    $("#dialog").dialog("close");
                    $("#dg").datagrid("reload");
                } else {
                    $.messager.alert("系统提示", result.errorInfo);
                }
            });
        }



        var a;
        //修改saleListProduct
        function editSaleListProduct() {
            var row = $("#dg2").datagrid("getSelections");
            if (row.length != 1) {
                $.messager.alert("系统提示", "<span style='color: red;'>请选择一行要修改的数据！！</span>");
                return;
            }
            var rows = row[0];
           // console.log(rows);
            a = rows.accomplishNumber == null ? 0 : rows.accomplishNumber;
            if (rows.state == "提货" || rows.state == "装车") {
                $.messager.alert("系统提示", "<span style='color: red;'>产品已生产完成！不可修改！！</span>");
            }else {
                if (rows.state == "审核通过" || rows.state == "下单") {
                    rows.jiTai = null;
                    rows.informNumber = null;
                } else if (rows.state.startsWith("生产完成")) {
                    rows.state = "下发机台：" + row[0].jiTai.name;
                    rows.jiTai = row[0].jiTai.id;
                }
                $("#dlg2").dialog("open").dialog("setTitle", "修改商标信息");
                $("#saleList").val(rows.saleList);
                rows.saleList = row[0].saleList.id;

                $("#fm2").form("load", rows);
            }
        }


        //关闭dig2
        function closeGoodsDialog() {
            $("#dlg2").dialog("close");
        }

        //保存修改
        //封装订单信息传递后台
        function saveGoods() {
            $("#fm2").form("submit", {
                url: "/admin/saleListProduct/saveInfo",
                onSubmit: function () {
                    if (!$(this).form("validate")) {
                        return false;
                    }
                    if (a >= $("#num").val()) {
                        $.messager.alert("系统提示", "生产已完成，数量无法减少！");
                        return false;
                    }
                    return true;
                },
                success: function (result) {
                    // console.log(result);
                    // console.log(typeof(result));
                    // var results = eval('(' + result + ')');
                    if (result.success) {
                        alert("保存成功！");
                        window.location.reload();
                    } else {
                        $.messager.alert("系统提示", "保存失败！");
                    }
                }
            });
        }

        function dingdanjiaji(){
            var row = $("#dg").datagrid("getSelections");
            if($("#up").combobox("getValue")==""){
                $.messager.alert("系统提示", "请选择加急级别！");
                return;
            }
            $.post("/admin/saleListProduct/dingdanjiaji", {
                id: row[0].id,
                jiajidengji: $("#up").combobox("getValue")
            }, function (result) {
                if (result.success) {
                    $("#dg").datagrid("reload");
                    $("#dg2").datagrid("reload");
                    $.messager.alert("系统提示", "操作成功！");
                }
            });
        }

        function chanpinjiaji(){
            var row = $("#dg2").datagrid("getSelections");
            console.log(row)
            if($("#down").combobox("getValue")==""){
                $.messager.alert("系统提示", "请选择加急级别！");
                return;
            }
            for(var i=0;i<row.length;i++){
                if(row[i].state=="生产完成"){
                    $.messager.alert("系统提示", "产品已生产完成！");
                    return;
                }
                else {
                    var ids = [];
                    for (var i = 0; i < $("#dg2").datagrid("getSelections").length; i++) {
                        ids.push($("#dg2").datagrid("getSelections")[i].id);
                    }
                    var idsStr = ids.join(",");
                    $.post("/admin/saleListProduct/chanpinjiaji", {
                        idsStr: idsStr,
                        jiajidengji: $("#down").combobox("getValue")
                    }, function (result) {
                        if (result.success) {
                            $("#dg2").datagrid("reload");
                            $.messager.alert("系统提示", "操作成功！");
                        }
                    }, "json");
                }
            }


        }




    </script>
</head>
<body class="easyui-layout" style="margin: 1px">
<div region="north" style="height: 300px">
    <table id="dg" title="销售单据查询" class="easyui-datagrid"
           fitColumns="false" rownumbers="true" singleSelect="true" fit="true"
           toolbar="#tb" split="true">
        <thead>
        <th field="id" width="20" align="center">销售单号</th>
        <th field="saleNumber" width="150" align="center">销售单号</th>
        <th field="saleDate" width="100" align="center"
            formatter="formatDate">销售日期
        </th>
        <th field="client" width="100" align="center"
            formatter="formatSupplier">客户
        </th>
        <th field="clerk" width="100" align="center"
            formatter="formatSupplier">业务员
        </th>
        <th field="user" width="150" align="center" formatter="formatUser">操作员</th>
        <th field="lankman" width="100" align="center">联系人</th>
        <th field="tel" width="100" align="center">客户电话</th>
        <th field="address" width="200" align="center">客户地址</th>
        <th field="deliveryDate" width="100" align="center"
            formatter="formatDate">发货时间
        </th>
        <th field="remark" width="100" align="center">备注</th>
        </thead>
    </table>

    <!-- dg顶部工具栏 -->
    <div id="tb">
        <fieldset style="border-color: #E7F0FF">
            <legend>查询设置</legend>
            &nbsp;单据号&nbsp; <input type="text" id="s_saleNumber" size="15"
                                   onkeydown="if(event.keyCode==13) searchSale()"/>
            &nbsp;&nbsp;&nbsp;客户：&nbsp;<input class="easyui-combobox"
                                              id="s_client" name="client.id" style="width: 80px"
                                              data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/client/clientList'"/>
            &nbsp;&nbsp;&nbsp;业务员：&nbsp;<input class="easyui-combobox"
                                               id="s_clerk" name="clerk.id" style="width: 80px"
                                               data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/clerk/clerkList'"/>
            &nbsp;&nbsp;&nbsp;日期：&nbsp; <input id="s_bSaleDate"
                                               class="easyui-datebox" editable=false style="width: 100px"/>
            &nbsp;&nbsp;&nbsp;&nbsp; <input id="s_eSaleDate"
                                             class="easyui-datebox" editable=false style="width: 100px"/>
            &nbsp;&nbsp;<a href="javascript:searchSale()"
                           class="easyui-linkbutton" iconCls="icon-search" plain="true">搜索</a>


            &nbsp;&nbsp;<input class="easyui-combobox" id = "up" style="width: 100px" data-options="
                            panelHeight:'auto',
                            valueField: 'label',
                            textField: 'value',
                            data: [{
                                label: '1',
                                value: '初级加急单'
                            },{
                                label: '2',
                                value: '中级加急单'
                            },{
                                label: '3',
                                value: '高级加急单'
                            },{
                                label: '0',
                                value: '--取消加急--'
                            }]" />
            &nbsp;&nbsp;<a href="javascript:dingdanjiaji()"
               class="easyui-linkbutton" iconCls="icon-ok" plain="true">订单加急</a>
        </fieldset>
    </div>
</div>

<div region="center" style="margin-top: 5px">
    <table id="dg2" class="easyui-datagrid" fitColumns="false"
           rownumbers="true" fit="true" split="true" toolbar="#tb2">
    </table>
</div>

<div id="tb2">
    <div>
        &nbsp;&nbsp;<input class="easyui-combobox" id = "down" style="width: 100px" data-options="
                            panelHeight:'auto',
                            valueField: 'label',
                            textField: 'value',
                            data: [{
                                label: '1',
                                value: '初级加急单'
                            },{
                                label: '2',
                                value: '中级加急单'
                            },{
                                label: '3',
                                value: '高级加急单'
                            },{
                                label: '0',
                                value: '--取消加急--'
                            }]" />
        &nbsp;&nbsp;<a href="javascript:chanpinjiaji()"
                       class="easyui-linkbutton" iconCls="icon-ok" plain="true">产品加急</a>
    </div>
</div>

</body>
</html>